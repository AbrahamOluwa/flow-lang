# Crypto Portfolio Tracker
# Calculates total portfolio value from coin holdings and prices.

config:
    name: "Crypto Portfolio"
    version: 1

services:
    CoinGecko is an API at "https://api.coingecko.com/api/v3"

workflow:
    trigger: when portfolio check is requested

    set coins to request.coins
    set total-value to 0
    set coin-count to 0
    log "Calculating portfolio value"

    for each coin in coins:
        set name to coin.name
        set amount to coin.amount
        set price to coin.price

        get latest using CoinGecko at "/simple/price" with ids name and vs-currencies "usd"
            save the result as market-data

        set coin-value to amount times price
        set total-value to total-value plus coin-value
        set coin-count to coin-count plus 1
        log "{name}: {amount} coins at {price} USD = {coin-value} USD"

    log "Total portfolio value: {total-value} USD"

    step Evaluate:
        if total-value is above 50000:
            set rating to "whale"
        otherwise if total-value is above 10000:
            set rating to "solid portfolio"
        otherwise:
            set rating to "growing"

    complete with total total-value and coins coin-count and rating rating
