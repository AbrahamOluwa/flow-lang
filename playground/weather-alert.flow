# Weather Alert System
# Checks weather conditions and decides whether to send a notification.

config:
    name: "Weather Alert"
    version: 1

services:
    Weather is an API at "https://api.openweathermap.org/data/2.5"
    Slack is an API at "https://slack.com/api"

workflow:
    trigger: when a weather check is requested

    set city to request.city
    set temp to request.temp
    set condition to request.condition
    set threshold to request.threshold
    log "Checking weather for {city}"

    get forecast using Weather at "/weather" with q city and units "metric"
        save the result as forecast

    log "Current: {temp} degrees, {condition}"

    step EvaluateConditions:
        if temp is above threshold:
            set alert to "Heat warning in {city}: {temp} degrees"
            set severity to "high"
        otherwise if condition is "storm":
            set alert to "Storm warning in {city}: {condition}"
            set severity to "high"
        otherwise if temp is below 0:
            set alert to "Freeze warning in {city}: {temp} degrees"
            set severity to "medium"
        otherwise:
            set alert to "none"
            set severity to "low"

    step NotifyIfNeeded:
        if alert is not "none":
            log "Sending alert: {alert}"
            send notification using Slack at "/chat.postMessage" with text alert and channel "#weather-alerts"
            complete with status "alert-sent" and message alert and severity severity
        otherwise:
            log "No alert needed â€” conditions are normal"
            complete with status "all-clear" and temp temp and city city
