{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "name": "Flow",
    "scopeName": "source.flow",
    "patterns": [
        { "include": "#comments" },
        { "include": "#strings" },
        { "include": "#numbers" },
        { "include": "#booleans" },
        { "include": "#top-level-blocks" },
        { "include": "#step-declarations" },
        { "include": "#trigger" },
        { "include": "#save-keywords" },
        { "include": "#error-handling" },
        { "include": "#control-flow" },
        { "include": "#comparison-operators" },
        { "include": "#math-operators" },
        { "include": "#logical-operators" },
        { "include": "#service-references" },
        { "include": "#service-types" },
        { "include": "#action-keywords" },
        { "include": "#env-access" },
        { "include": "#dot-access" },
        { "include": "#identifiers" }
    ],
    "repository": {
        "comments": {
            "patterns": [
                {
                    "name": "comment.line.number-sign.flow",
                    "match": "#.*$"
                }
            ]
        },
        "strings": {
            "patterns": [
                {
                    "name": "string.quoted.double.flow",
                    "begin": "\"",
                    "end": "\"",
                    "patterns": [
                        {
                            "name": "constant.character.escape.flow",
                            "match": "\\\\[\"\\\\nt{}]"
                        },
                        {
                            "name": "meta.interpolation.flow",
                            "begin": "\\{",
                            "end": "\\}",
                            "beginCaptures": {
                                "0": { "name": "punctuation.section.interpolation.begin.flow" }
                            },
                            "endCaptures": {
                                "0": { "name": "punctuation.section.interpolation.end.flow" }
                            },
                            "patterns": [
                                {
                                    "name": "variable.language.flow",
                                    "match": "\\benv\\b"
                                },
                                {
                                    "name": "variable.other.property.flow",
                                    "match": "(?<=\\.)[a-zA-Z_][a-zA-Z0-9_-]*"
                                },
                                {
                                    "name": "variable.other.flow",
                                    "match": "[a-zA-Z_][a-zA-Z0-9_-]*"
                                },
                                {
                                    "name": "punctuation.accessor.flow",
                                    "match": "\\."
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        "numbers": {
            "patterns": [
                {
                    "name": "constant.numeric.flow",
                    "match": "\\b\\d+(\\.\\d+)?\\b"
                }
            ]
        },
        "booleans": {
            "patterns": [
                {
                    "name": "constant.language.boolean.flow",
                    "match": "\\b(true|false)\\b"
                }
            ]
        },
        "top-level-blocks": {
            "patterns": [
                {
                    "match": "^\\s*(config|services|workflow)\\s*(:)",
                    "captures": {
                        "1": { "name": "storage.type.flow" },
                        "2": { "name": "punctuation.separator.flow" }
                    }
                }
            ]
        },
        "step-declarations": {
            "patterns": [
                {
                    "match": "\\b(step)\\s+([A-Za-z][A-Za-z0-9_-]*)\\s*(:)",
                    "captures": {
                        "1": { "name": "keyword.control.flow" },
                        "2": { "name": "entity.name.function.flow" },
                        "3": { "name": "punctuation.separator.flow" }
                    }
                }
            ]
        },
        "trigger": {
            "patterns": [
                {
                    "match": "\\b(trigger)\\s*(:)",
                    "captures": {
                        "1": { "name": "keyword.control.flow" },
                        "2": { "name": "punctuation.separator.flow" }
                    }
                }
            ]
        },
        "save-keywords": {
            "patterns": [
                {
                    "name": "keyword.other.flow",
                    "match": "\\b(save\\s+the\\s+response\\s+headers\\s+as|save\\s+the\\s+confidence\\s+as|save\\s+the\\s+result\\s+as|save\\s+the\\s+status\\s+as)\\b"
                }
            ]
        },
        "error-handling": {
            "patterns": [
                {
                    "match": "\\b(on\\s+failure|on\\s+timeout)\\s*(:)",
                    "captures": {
                        "1": { "name": "keyword.control.flow" },
                        "2": { "name": "punctuation.separator.flow" }
                    }
                },
                {
                    "name": "keyword.control.flow",
                    "match": "\\b(if\\s+still\\s+failing)\\s*(:)"
                },
                {
                    "name": "keyword.control.flow",
                    "match": "\\b(retry)\\b"
                },
                {
                    "name": "keyword.control.flow",
                    "match": "\\b(waiting)\\b"
                }
            ]
        },
        "control-flow": {
            "patterns": [
                {
                    "match": "\\b(otherwise\\s+if)\\b",
                    "name": "keyword.control.flow"
                },
                {
                    "match": "\\b(otherwise)\\s*(:)",
                    "captures": {
                        "1": { "name": "keyword.control.flow" },
                        "2": { "name": "punctuation.separator.flow" }
                    }
                },
                {
                    "match": "\\b(for\\s+each)\\b",
                    "name": "keyword.control.flow"
                },
                {
                    "match": "\\b(if)\\b",
                    "name": "keyword.control.flow"
                }
            ]
        },
        "comparison-operators": {
            "patterns": [
                {
                    "name": "keyword.operator.comparison.flow",
                    "match": "\\b(is\\s+not\\s+empty|is\\s+at\\s+least|is\\s+at\\s+most|does\\s+not\\s+exist|is\\s+not|is\\s+above|is\\s+below|is\\s+empty|contains|exists)\\b"
                },
                {
                    "name": "keyword.operator.comparison.flow",
                    "match": "\\b(is)\\b"
                }
            ]
        },
        "math-operators": {
            "patterns": [
                {
                    "name": "keyword.operator.arithmetic.flow",
                    "match": "\\b(divided\\s+by|rounded\\s+to|plus|minus|times)\\b"
                }
            ]
        },
        "logical-operators": {
            "patterns": [
                {
                    "name": "keyword.operator.logical.flow",
                    "match": "\\b(and|or|not)\\b"
                }
            ]
        },
        "service-references": {
            "patterns": [
                {
                    "match": "\\b(using|ask)\\s+([A-Z][A-Za-z0-9_-]*)",
                    "captures": {
                        "1": { "name": "keyword.other.flow" },
                        "2": { "name": "entity.name.type.flow" }
                    }
                }
            ]
        },
        "service-types": {
            "patterns": [
                {
                    "name": "support.type.flow",
                    "match": "\\b(API|AI|plugin|webhook)\\b"
                }
            ]
        },
        "action-keywords": {
            "patterns": [
                {
                    "name": "keyword.other.flow",
                    "match": "\\b(set|to|using|with|at|in|as|log|complete|reject|skip|every|when|manual|times|seconds|minutes)\\b"
                }
            ]
        },
        "env-access": {
            "patterns": [
                {
                    "name": "variable.language.flow",
                    "match": "\\b(env|request)\\b"
                }
            ]
        },
        "dot-access": {
            "patterns": [
                {
                    "match": "(\\.)([a-zA-Z_][a-zA-Z0-9_-]*)",
                    "captures": {
                        "1": { "name": "punctuation.accessor.flow" },
                        "2": { "name": "variable.other.property.flow" }
                    }
                }
            ]
        },
        "identifiers": {
            "patterns": [
                {
                    "name": "variable.other.flow",
                    "match": "\\b[a-zA-Z_][a-zA-Z0-9_-]*\\b"
                }
            ]
        }
    }
}
